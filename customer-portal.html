<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Portal - A & K Analytics</title>
    <meta name="description" content="Access your A & K Analytics portal for dashboards, bookings, analyst support, and data analytics.">
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.5.0/dist/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.calendly.com/1.13.0/calendly.min.js"></script>
    <link rel="stylesheet" href="https://cdn.calendly.com/1.13.0/calendly.min.css">
    <style>
        .hero-section { background: linear-gradient(to right, #2563eb, #1e40af); color: white; padding: 2rem; }
        .logo { font-size: 1.5rem; font-weight: bold; }
        .logo span { font-size: 1rem; font-weight: normal; }
        .nav-link { color: white; padding: 0.5rem; }
        .nav-link:hover { text-decoration: underline; }
        .submit-btn { background-color: #2563eb; color: white; padding: 0.5rem 1rem; border-radius: 0.25rem; }
        .submit-btn:hover { background-color: #1e40af; }
        .action-btn { background-color: #2563eb; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; margin-right: 0.5rem; }
        .action-btn.cancel-btn { background-color: #dc2626; }
        .action-btn:hover { opacity: 0.9; }
        .footer-section { background: #1f2937; color: white; padding: 2rem; }
        .footer-nav a { color: white; margin-right: 1rem; }
        .footer-social a { color: white; margin-right: 1rem; }
        .error, .success { display: none; margin-bottom: 1rem; text-align: center; }
        .error { color: #dc2626; }
        .success { color: #16a34a; }
        .card { background: white; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); padding: 1.5rem; }
        @media (max-width: 768px) {
            .grid-cols-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Utility functions (from auth.js equivalent)
        const getToken = () => localStorage.getItem('token');
        const setToken = (token) => localStorage.setItem('token', token);
        const removeToken = () => localStorage.removeItem('token');
        const getUserId = () => localStorage.getItem('userId');
        const setUserId = (id) => localStorage.setItem('userId', id);
        const sanitizeInput = (input) => {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        };
        const validateEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

        // Main App Component
        const CustomerPortal = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            useEffect(() => {
                const token = getToken();
                if (!token) {
                    window.location.href = 'login.html';
                    return;
                }
                fetchProfile(token);
            }, []);

            const fetchProfile = async (token) => {
                try {
                    const response = await axios.get('https://a-k-analytics-backend.onrender.com/api/users/profile', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    setUser(response.data);
                    setUserId(response.data._id);
                } catch (err) {
                    setError('Session expired. Please log in again.');
                    removeToken();
                    setTimeout(() => window.location.href = 'login.html', 2000);
                } finally {
                    setLoading(false);
                }
            };

            const logout = () => {
                removeToken();
                localStorage.removeItem('userId');
                window.location.href = 'login.html';
            };

            if (loading) {
                return (
                    <div className="text-center p-4">
                        <p>Loading...</p>
                    </div>
                );
            }

            return (
                <div>
                    <section className="hero-section">
                        <header className="container mx-auto flex justify-between items-center">
                            <div className="logo">
                                A & K Analytics
                                <span>Data Solutions</span>
                            </div>
                            <nav>
                                <ul className="flex space-x-4">
                                    <li><a href="index.html" className="nav-link">Home</a></li>
                                    <li><a href="book-online.html" className="nav-link">Book Services</a></li>
                                    <li><a href="#" onClick={logout} className="nav-link">Logout</a></li>
                                </ul>
                            </nav>
                        </header>
                    </section>
                    <div className="container mx-auto p-6">
                        <h1 className="text-3xl font-bold mb-6">
                            Welcome, {user?.name}!
                        </h1>
                        {error && <div className="error">{error}</div>}
                        {success && <div className="success">{success}</div>}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <Dashboard />
                            <ServiceBooking setSuccess={setSuccess} setError={setError} />
                            <ScheduleCall />
                            <LiveChat />
                            <DataUpload setSuccess={setSuccess} setError={setError} />
                            <DatabaseConnection setSuccess={setSuccess} setError={setError} />
                        </div>
                    </div>
                    <footer className="footer-section">
                        <div className="footer-content container mx-auto">
                            <div className="footer-logo">
                                A & K Analytics
                                <span>Data Solutions</span>
                            </div>
                            <nav className="footer-nav">
                                <ul className="flex flex-wrap">
                                    <li><a href="about.html">About</a></li>
                                    <li><a href="industries.html">Industries</a></li>
                                    <li><a href="insights.html">Insights</a></li>
                                    <li><a href="index.html#contact">Contact</a></li>
                                    <li><a href="blog.html">Blog</a></li>
                                    <li><a href="book-online.html">Book Online</a></li>
                                </ul>
                            </nav>
                            <div className="footer-social">
                                <a href="https://facebook.com/akanalytics" className="social-icon" aria-label="Facebook"><i className="fab fa-facebook-f"></i></a>
                                <a href="https://twitter.com/akanalytics" className="social-icon" aria-label="Twitter"><i className="fab fa-twitter"></i></a>
                                <a href="https://linkedin.com/company/akanalytics" className="social-icon" aria-label="LinkedIn"><i className="fab fa-linkedin-in"></i></a>
                                <a href="https://instagram.com/akanalytics" className="social-icon" aria-label="Instagram"><i className="fab fa-instagram"></i></a>
                            </div>
                            <div className="footer-copyright">
                                <p>Â© 2025 A & K Analytics. All rights reserved.</p>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        // Dashboard Component
        const Dashboard = () => {
            const [dashboardUrl, setDashboardUrl] = useState('');
            const [analytics, setAnalytics] = useState([]);

            useEffect(() => {
                const token = getToken();
                axios.get('https://a-k-analytics-backend.onrender.com/api/customer/dashboard', {
                    headers: { Authorization: `Bearer ${token}` }
                }).then(res => {
                    setDashboardUrl(res.data.dashboardUrl || 'https://public.tableau.com/views/sample-sales-dashboard');
                }).catch(err => {
                    console.error('Error loading dashboard:', err);
                });

                axios.get('https://a-k-analytics-backend.onrender.com/api/customer/analytics', {
                    headers: { Authorization: `Bearer ${token}` }
                }).then(res => {
                    setAnalytics(res.data);
                }).catch(err => {
                    console.error('Error loading analytics:', err);
                });
            }, []);

            return (
                <div className="card col-span-2">
                    <h2 className="text-2xl font-bold mb-4">Personalized Dashboard</h2>
                    <iframe src={dashboardUrl} width="100%" height="600px" className="border rounded"></iframe>
                    <h3 className="text-xl font-bold mt-4 mb-2">Analytics Reports</h3>
                    {analytics.length ? (
                        <ul className="space-y-2">
                            {analytics.map(report => (
                                <li key={report._id} className="border-b py-2">
                                    <p><strong>{sanitizeInput(report.title)}</strong> - {sanitizeInput(report.status)}</p>
                                    {report.resultsUrl && (
                                        <a href={report.resultsUrl} target="_blank" className="action-btn">View Report</a>
                                    )}
                                </li>
                            ))}
                        </ul>
                    ) : (
                        <p>No analytics reports available.</p>
                    )}
                </div>
            );
        };

        // Service Booking Component
        const ServiceBooking = ({ setSuccess, setError }) => {
            const [bookings, setBookings] = useState([]);
            const [service, setService] = useState('');
            const services = [
                { value: 'basic_report', label: 'Basic Report (KES 15,000 / USD 115)' },
                { value: 'advanced_forecasting', label: 'Advanced Forecasting (KES 50,000 / USD 385)' },
                { value: 'ml_model', label: 'Machine Learning Model (KES 100,000 / USD 770)' }
            ];

            useEffect(() => {
                const token = getToken();
                axios.get('https://a-k-analytics-backend.onrender.com/api/customer/bookings', {
                    headers: { Authorization: `Bearer ${token}` }
                }).then(res => {
                    setBookings(res.data);
                }).catch(err => {
                    console.error('Error loading bookings:', err);
                });
            }, []);

            const handleBooking = async (e) => {
                e.preventDefault();
                if (!service) {
                    setError('Please select a service.');
                    return;
                }
                try {
                    const token = getToken();
                    const response = await axios.post('https://a-k-analytics-backend.onrender.com/api/customer/bookings', {
                        service
                    }, {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    setBookings([...bookings, response.data]);
                    setSuccess('Service booked successfully!');
                    setError('');
                    setService('');
                } catch (err) {
                    setError('Failed to book service.');
                    console.error('Error booking service:', err);
                }
            };

            const cancelBooking = async (id) => {
                if (window.confirm('Cancel this booking?')) {
                    try {
                        const token = getToken();
                        await axios.delete(`https://a-k-analytics-backend.onrender.com/api/customer/bookings/${id}`, {
                            headers: { Authorization: `Bearer ${token}` }
                        });
                        setBookings(bookings.filter(b => b._id !== id));
                        setSuccess('Booking cancelled.');
                        setError('');
                    } catch (err) {
                        setError('Failed to cancel booking.');
                        console.error('Error cancelling booking:', err);
                    }
                }
            };

            return (
                <div className="card">
                    <h2 className="text-2xl font-bold mb-4">Book Our Services</h2>
                    <form onSubmit={handleBooking} className="space-y-4">
                        <div>
                            <label htmlFor="service" className="block text-gray-700">Select Service</label>
                            <select
                                id="service"
                                value={service}
                                onChange={(e) => setService(e.target.value)}
                                className="w-full p-2 border rounded"
                                required
                            >
                                <option value="">Choose a service</option>
                                {services.map(s => (
                                    <option key={s.value} value={s.value}>{s.label}</option>
                                ))}
                            </select>
                        </div>
                        <button type="submit" className="submit-btn">Book Service</button>
                    </form>
                    <h3 className="text-xl font-bold mt-4 mb-2">My Bookings</h3>
                    {bookings.length ? (
                        <ul className="space-y-2">
                            {bookings.map(b => (
                                <li key={b._id} className="border-b py-2 flex justify-between items-center">
                                    <p>{sanitizeInput(b.service)} - {new Date(b.callTime).toLocaleString()}</p>
                                    <button onClick={() => cancelBooking(b._id)} className="action-btn cancel-btn">Cancel</button>
                                </li>
                            ))}
                        </ul>
                    ) : (
                        <p>No bookings yet.</p>
                    )}
                </div>
            );
        };

        // Schedule Call Component
        const ScheduleCall = () => {
            useEffect(() => {
                Calendly.initInlineWidget({
                    url: 'https://calendly.com/akanalytics/consultation',
                    parentElement: document.getElementById('calendly-widget'),
                    prefill: { email: localStorage.getItem('email') }
                });
            }, []);

            return (
                <div className="card">
                    <h2 className="text-2xl font-bold mb-4">Schedule a Call</h2>
                    <div id="calendly-widget" className="h-96"></div>
                </div>
            );
        };

        // Live Chat Component
        const LiveChat = () => {
            const [messages, setMessages] = useState([]);
            const [message, setMessage] = useState('');

            useEffect(() => {
                const socket = io('https://a-k-analytics-backend.onrender.com');
                socket.on('connect', () => {
                    socket.emit('join', { userId: getUserId(), role: 'customer' });
                });
                socket.on('message', (data) => {
                    setMessages(prev => [...prev, { sender: data.sender, text: data.text }]);
                    const chatMessages = document.getElementById('chat-messages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
                return () => socket.disconnect();
            }, []);

            const sendMessage = () => {
                if (message.trim()) {
                    const socket = io('https://a-k-analytics-backend.onrender.com');
                    socket.emit('message', { text: message, sender: 'Customer' });
                    setMessages(prev => [...prev, { sender: 'Customer', text: message }]);
                    setMessage('');
                }
            };

            return (
                <div className="card">
                    <h2 className="text-2xl font-bold mb-4">Talk to an Analyst</h2>
                    <div id="chat-messages" className="h-64 overflow-y-scroll bg-gray-50 p-4 rounded">
                        {messages.map((msg, i) => (
                            <p key={i}><strong>{sanitizeInput(msg.sender)}:</strong> {sanitizeInput(msg.text)}</p>
                        ))}
                    </div>
                    <div className="flex mt-2">
                        <input
                            type="text"
                            value={message}
                            onChange={(e) => setMessage(e.target.value)}
                            className="w-full p-2 border rounded"
                            placeholder="Message analyst..."
                            aria-label="Chat message"
                        />
                        <button onClick={sendMessage} className="submit-btn ml-2">Send</button>
                    </div>
                </div>
            );
        };

        // Data Upload Component
        const DataUpload = ({ setSuccess, setError }) => {
            const handleUpload = async (e) => {
                e.preventDefault();
                const file = e.target.querySelector('#data-file').files[0];
                if (!file) {
                    setError('Please select a file.');
                    return;
                }
                const formData = new FormData();
                formData.append('data', file);
                try {
                    const token = getToken();
                    await axios.post('https://a-k-analytics-backend.onrender.com/api/customer/upload', formData, {
                        headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'multipart/form-data' }
                    });
                    setSuccess('Data uploaded successfully! Analysis in progress.');
                    setError('');
                    e.target.reset();
                } catch (err) {
                    setError('Data upload failed.');
                    console.error('Error uploading data:', err);
                }
            };

            return (
                <div className="card">
                    <h2 className="text-2xl font-bold mb-4">Upload Dataset</h2>
                    <form onSubmit={handleUpload} encType="multipart/form-data">
                        <input
                            type="file"
                            id="data-file"
                            accept=".csv,.xlsx"
                            className="mb-2"
                            aria-label="Upload data file"
                        />
                        <button type="submit" className="submit-btn">Upload</button>
                    </form>
                </div>
            );
        };

        // Database Connection Component
        const DatabaseConnection = ({ setSuccess, setError }) => {
            const [dbType, setDbType] = useState('');
            const [host, setHost] = useState('');
            const [port, setPort] = useState('');
            const [database, setDatabase] = useState('');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');

            const handleConnect = async (e) => {
                e.preventDefault();
                if (!dbType || !host || !port || !database || !username || !password) {
                    setError('Please fill all fields.');
                    return;
                }
                try {
                    const token = getToken();
                    await axios.post('https://a-k-analytics-backend.onrender.com/api/customer/db-connect', {
                        dbType,
                        host,
                        port,
                        database,
                        username,
                        password
                    }, {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    setSuccess('Database connected successfully! Analysis in progress.');
                    setError('');
                    setDbType('');
                    setHost('');
                    setPort('');
                    setDatabase('');
                    setUsername('');
                    setPassword('');
                } catch (err) {
                    setError('Database connection failed.');
                    console.error('Error connecting to database:', err);
                }
            };

            return (
                <div className="card">
                    <h2 className="text-2xl font-bold mb-4">Connect Database</h2>
                    <form onSubmit={handleConnect} className="space-y-4">
                        <div>
                            <label htmlFor="db-type" className="block text-gray-700">Database Type</label>
                            <select
                                id="db-type"
                                value={dbType}
                                onChange={(e) => setDbType(e.target.value)}
                                className="w-full p-2 border rounded"
                                required
                            >
                                <option value="">Select type</option>
                                <option value="postgresql">PostgreSQL</option>
                                <option value="mysql">MySQL</option>
                                <option value="mongodb">MongoDB</option>
                            </select>
                        </div>
                        <div>
                            <label htmlFor="host" className="block text-gray-700">Host</label>
                            <input
                                type="text"
                                id="host"
                                value={host}
                                onChange={(e) => setHost(e.target.value)}
                                className="w-full p-2 border rounded"
                                placeholder="e.g., localhost"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="port" className="block text-gray-700">Port</label>
                            <input
                                type="number"
                                id="port"
                                value={port}
                                onChange={(e) => setPort(e.target.value)}
                                className="w-full p-2 border rounded"
                                placeholder="e.g., 5432"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="database" className="block text-gray-700">Database Name</label>
                            <input
                                type="text"
                                id="database"
                                value={database}
                                onChange={(e) => setDatabase(e.target.value)}
                                className="w-full p-2 border rounded"
                                placeholder="e.g., mydb"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="username" className="block text-gray-700">Username</label>
                            <input
                                type="text"
                                id="username"
                                value={username}
                                onChange={(e) => setUsername(e.target.value)}
                                className="w-full p-2 border rounded"
                                placeholder="e.g., admin"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="password" className="block text-gray-700">Password</label>
                            <input
                                type="password"
                                id="password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="w-full p-2 border rounded"
                                required
                            />
                        </div>
                        <button type="submit" className="submit-btn">Connect</button>
                    </form>
                </div>
            );
        };

        // Render App
        ReactDOM.render(<CustomerPortal />, document.getElementById('root'));
    </script>
</body>
</html>