<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Portal - A & K Analytics</title>
    <meta name="description" content="Access your A & K Analytics portal for dashboards, bookings, analyst support, and data analytics.">
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js"></script>
    <script type="module" src="auth.js"></script>
    <style>
        .hero-section { background: linear-gradient(to right, #2563eb, #1e40af); color: white; padding: 2rem; }
        .logo { font-size: 1.5rem; font-weight: bold; }
        .logo span { font-size: 1rem; font-weight: normal; }
        .nav-link { color: white; padding: 0.5rem; }
        .nav-link:hover { text-decoration: underline; }
        .submit-btn { background-color: #2563eb; color: white; padding: 0.5rem 1rem; border-radius: 0.25rem; }
        .submit-btn:hover { background-color: #1e40af; }
        .action-btn { background-color: #2563eb; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; margin-right: 0.5rem; }
        .action-btn.cancel-btn { background-color: #dc2626; }
        .action-btn:hover { opacity: 0.9; }
        .footer-section { background: #1f2937; color: white; padding: 2rem; }
        .footer-nav a { color: white; margin-right: 1rem; }
        .footer-social a { color: white; margin-right: 1rem; }
        .error, .success { margin-bottom: 1rem; text-align: center; }
        .error { color: #dc2626; display: block; }
        .success { color: #16a34a; display: block; }
        .card { background: white; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); padding: 1.5rem; }
        @media (max-width: 768px) {
            .grid-cols-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Import auth utilities
        import { getToken, removeToken, sanitizeInput, fetchUserProfile } from '/auth.js';

        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            state = { hasError: false, errorMessage: '' };
            static getDerivedStateFromError(error) {
                return { hasError: true, errorMessage: error.message };
            }
            componentDidCatch(error, info) {
                console.error('ErrorBoundary caught:', error, info);
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="container mx-auto p-6">
                            <h1 className="text-2xl font-bold text-red-600">Something went wrong</h1>
                            <p>{this.state.errorMessage}</p>
                            <p>Please try refreshing the page or <a href="login.html" className="text-blue-600">log in again</a>.</p>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // Main App Component
        const CustomerPortal = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            useEffect(() => {
                console.log('CustomerPortal useEffect: Initializing');
                const token = getToken();
                if (!token) {
                    console.warn('No token found, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                fetchProfile(token);
            }, []);

            const fetchProfile = async (token) => {
                try {
                    console.log('Fetching profile with token:', token);
                    const userData = await fetchUserProfile(token);
                    console.log('Profile fetched:', userData);
                    setUser(userData);
                    localStorage.setItem('userId', userData._id);
                    localStorage.setItem('email', userData.email);
                } catch (err) {
                    console.error('Profile fetch error:', err.message);
                    setError('Session expired or profile fetch failed. Please log in again.');
                    removeToken();
                    localStorage.removeItem('userId');
                    localStorage.removeItem('email');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                } finally {
                    setLoading(false);
                }
            };

            const logout = () => {
                console.log('Logging out');
                removeToken();
                localStorage.removeItem('userId');
                localStorage.removeItem('email');
                window.location.href = 'login.html';
            };

            if (loading) {
                return (
                    <div className="text-center p-4">
                        <p>Loading customer portal...</p>
                    </div>
                );
            }

            return (
                <ErrorBoundary>
                    <div>
                        <section className="hero-section">
                            <header className="container mx-auto flex justify-between items-center">
                                <div className="logo">
                                    A & K Analytics
                                    <span>Data Solutions</span>
                                </div>
                                <nav>
                                    <ul className="flex space-x-4">
                                        <li><a href="index.html" className="nav-link">Home</a></li>
                                        <li><a href="book-online.html" className="nav-link">Book Services</a></li>
                                        <li><a href="#" onClick={logout} className="nav-link">Logout</a></li>
                                    </ul>
                                </nav>
                            </header>
                        </section>
                        <div className="container mx-auto p-6">
                            <h1 className="text-3xl font-bold mb-6">
                                Welcome, {user?.name || 'Customer'}!
                            </h1>
                            {error && <div className="error">{error}</div>}
                            {success && <div className="success">{success}</div>}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <Dashboard setError={setError} />
                                <ServiceBooking setSuccess={setSuccess} setError={setError} />
                            </div>
                        </div>
                        <footer className="footer-section">
                            <div className="footer-content container mx-auto">
                                <div className="footer-logo">
                                    A & K Analytics
                                    <span>Data Solutions</span>
                                </div>
                                <nav className="footer-nav">
                                    <ul className="flex flex-wrap">
                                        <li><a href="about.html">About</a></li>
                                        <li><a href="industries.html">Industries</a></li>
                                        <li><a href="insights.html">Insights</a></li>
                                        <li><a href="index.html#contact">Contact</a></li>
                                        <li><a href="blog.html">Blog</a></li>
                                        <li><a href="book-online.html">Book Online</a></li>
                                    </ul>
                                </nav>
                                <div className="footer-social">
                                    <a href="https://facebook.com/akanalytics" className="social-icon" aria-label="Facebook"><i className="fab fa-facebook-f"></i></a>
                                    <a href="https://twitter.com/akanalytics" className="social-icon" aria-label="Twitter"><i className="fab fa-twitter"></i></a>
                                    <a href="https://linkedin.com/company/akanalytics" className="social-icon" aria-label="LinkedIn"><i className="fab fa-linkedin-in"></i></a>
                                    <a href="https://instagram.com/akanalytics" className="social-icon" aria-label="Instagram"><i className="fab fa-instagram"></i></a>
                                </div>
                                <div className="footer-copyright">
                                    <p>Â© 2025 A & K Analytics. All rights reserved.</p>
                                </div>
                            </div>
                        </footer>
                    </div>
                </ErrorBoundary>
            );
        };

        // Dashboard Component
        const Dashboard = ({ setError }) => {
            const [dashboardUrl, setDashboardUrl] = useState('');
            const [analytics, setAnalytics] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                console.log('Dashboard useEffect: Fetching data');
                const token = getToken();
                Promise.all([
                    axios.get('https://a-k-analytics-backend.onrender.com/api/customer/dashboard', {
                        headers: { Authorization: `Bearer ${token}` }
                    }).then(res => {
                        console.log('Dashboard response:', res.data);
                        setDashboardUrl(res.data.dashboardUrl || 'https://public.tableau.com/views/sample-sales-dashboard');
                    }).catch(err => {
                        console.error('Dashboard fetch error:', err);
                        setError('Failed to load dashboard.');
                    }),
                    axios.get('https://a-k-analytics-backend.onrender.com/api/customer/analytics', {
                        headers: { Authorization: `Bearer ${token}` }
                    }).then(res => {
                        console.log('Analytics response:', res.data);
                        setAnalytics(res.data || []);
                    }).catch(err => {
                        console.error('Analytics fetch error:', err);
                        setError('Failed to load analytics reports.');
                    })
                ]).finally(() => {
                    console.log('Dashboard fetch complete');
                    setLoading(false);
                });
            }, [setError]);

            if (loading) {
                return <div className="card col-span-2"><p>Loading dashboard...</p></div>;
            }

            return (
                <div className="card col-span-2">
                    <h2 className="text-2xl font-bold mb-4">Personalized Dashboard</h2>
                    {dashboardUrl ? (
                        <iframe src={dashboardUrl} width="100%" height="600px" className="border rounded" title="Customer Dashboard"></iframe>
                    ) : (
                        <p>No dashboard available. Contact support for setup.</p>
                    )}
                    <h3 className="text-xl font-bold mt-4 mb-2">Analytics Reports</h3>
                    {analytics.length ? (
                        <ul className="space-y-2">
                            {analytics.map(report => (
                                <li key={report._id} className="border-b py-2">
                                    <p><strong>{sanitizeInput(report.title)}</strong> - {sanitizeInput(report.status)}</p>
                                    {report.resultsUrl && (
                                        <a href={report.resultsUrl} target="_blank" rel="noopener noreferrer" className="action-btn">View Report</a>
                                    )}
                                </li>
                            ))}
                        </ul>
                    ) : (
                        <p>No analytics reports available.</p>
                    )}
                </div>
            );
        };

        // Service Booking Component
        const ServiceBooking = ({ setSuccess, setError }) => {
            const [bookings, setBookings] = useState([]);
            const [service, setService] = useState('');
            const [loading, setLoading] = useState(true);
            const services = [
                { value: 'basic_report', label: 'Basic Report (KES 15,000 / USD 115)' },
                { value: 'advanced_forecasting', label: 'Advanced Forecasting (KES 50,000 / USD 385)' },
                { value: 'ml_model', label: 'Machine Learning Model (KES 100,000 / USD 770)' }
            ];

            useEffect(() => {
                console.log('ServiceBooking useEffect: Fetching bookings');
                const token = getToken();
                axios.get('https://a-k-analytics-backend.onrender.com/api/customer/bookings', {
                    headers: { Authorization: `Bearer ${token}` }
                }).then(res => {
                    console.log('Bookings response:', res.data);
                    setBookings(res.data || []);
                }).catch(err => {
                    console.error('Bookings fetch error:', err);
                    setError('Failed to load bookings.');
                }).finally(() => {
                    console.log('Bookings fetch complete');
                    setLoading(false);
                });
            }, [setError]);

            const handleBooking = async (e) => {
                e.preventDefault();
                if (!service) {
                    setError('Please select a service.');
                    return;
                }
                try {
                    console.log('Booking service:', service);
                    const token = getToken();
                    const response = await axios.post('https://a-k-analytics-backend.onrender.com/api/customer/bookings', {
                        service
                    }, {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    console.log('Booking response:', response.data);
                    setBookings([...bookings, response.data]);
                    setSuccess('Service booked successfully!');
                    setError('');
                    setService('');
                } catch (err) {
                    console.error('Booking error:', err);
                    setError('Failed to book service.');
                }
            };

            const cancelBooking = async (id) => {
                if (window.confirm('Cancel this booking?')) {
                    try {
                        console.log('Cancelling booking:', id);
                        const token = getToken();
                        await axios.delete(`https://a-k-analytics-backend.onrender.com/api/customer/bookings/${id}`, {
                            headers: { Authorization: `Bearer ${token}` }
                        });
                        setBookings(bookings.filter(b => b._id !== id));
                        setSuccess('Booking cancelled.');
                        setError('');
                    } catch (err) {
                        console.error('Cancel booking error:', err);
                        setError('Failed to cancel booking.');
                    }
                }
            };

            if (loading) {
                return <div className="card"><p>Loading bookings...</p></div>;
            }

            return (
                <div className="card">
                    <h2 className="text-2xl font-bold mb-4">Book Our Services</h2>
                    <form onSubmit={handleBooking} className="space-y-4">
                        <div>
                            <label htmlFor="service" className="block text-gray-700">Select Service</label>
                            <select
                                id="service"
                                value={service}
                                onChange={(e) => setService(e.target.value)}
                                className="w-full p-2 border rounded"
                                required
                            >
                                <option value="">Choose a service</option>
                                {services.map(s => (
                                    <option key={s.value} value={s.value}>{s.label}</option>
                                ))}
                            </select>
                        </div>
                        <button type="submit" className="submit-btn">Book Service</button>
                    </form>
                    <h3 className="text-xl font-bold mt-4 mb-2">My Bookings</h3>
                    {bookings.length ? (
                        <ul className="space-y-2">
                            {bookings.map(b => (
                                <li key={b._id} className="border-b py-2 flex justify-between items-center">
                                    <p>{sanitizeInput(b.service)} - {new Date(b.callTime).toLocaleString()}</p>
                                    <button onClick={() => cancelBooking(b._id)} className="action-btn cancel-btn">Cancel</button>
                                </li>
                            ))}
                        </ul>
                    ) : (
                        <p>No bookings yet.</p>
                    )}
                </div>
            );
        };

        // Test Render
        console.log('Attempting to render CustomerPortal');
        try {
            ReactDOM.render(<CustomerPortal />, document.getElementById('root'));
            console.log('Render successful');
        } catch (err) {
            console.error('Render failed:', err);
            document.getElementById('root').innerHTML = `
                <div className="container mx-auto p-6">
                    <h1 className="text-2xl font-bold text-red-600">Error Loading Portal</h1>
                    <p>Failed to load the customer portal: ${err.message}</p>
                    <p>Please try <a href="login.html" className="text-blue-600">logging in again</a>.</p>
                </div>
            `;
        }
    </script>
</body>
</html>